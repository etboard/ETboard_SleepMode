# ******************************************************************************************
# FileName     : deepsleep_counter_10m.py
# Description  : Deep Sleep 후 깨어났을 때 LED로 작업 중 표시 (10분 주기)
# Description  : wakeup_count.txt 파일을 저장하여 깨어난 횟수 기록
# Author       : 박은정
# Created Date : 2025.07.16
# Reference    :
# Modified     :
# ******************************************************************************************


#===========================================================================================
# 기본 모듈 사용하기
#===========================================================================================
import machine
import time
from machine import Pin
from ETboard.lib.pin_define import *                     # ETboard 핀 관련 모듈


#===========================================================================================
# 전역 변수 선언
#===========================================================================================
operation_led = Pin(D2)                                  # 작동 LED (빨강)


#===========================================================================================
def indicate_wakeup_activity():                          # 작업 표시
#===========================================================================================
    operation_led.init(Pin.OUT)
    operation_led.value(1)                               # LED 켜기
    time.sleep(2)                                        # 2초간 대기
    operation_led.value(0)                               # LED 끄기


#===========================================================================================
def get_wake_count():                                    # 깨어난 횟수 로드
#===========================================================================================
    try:
        with open('wake_count.txt', 'r') as f:
            return int(f.read().strip())
    except:
        return 0                                         # 읽기 실패 시 0으로 초기화


#===========================================================================================
def save_wake_count(count):                              # 깨어난 횟수 저장
#===========================================================================================
    with open('wake_count.txt', 'w') as f:
        f.write(str(count))


#===========================================================================================
def main():                                              # 메인 함수
#===========================================================================================
    reset_cause = machine.reset_cause()                  # 리셋 원인 확인
    wake_count = get_wake_count()                        # 이전까지의 깨어난 횟수 불러오기

    print("-" * 40)
    if reset_cause == machine.DEEPSLEEP_RESET:           # 딥슬립에서 깨어난 경우
        wake_count += 1
        print(f"Deep Sleep에서 깨어남 - {wake_count}번째")
    else:                                                # 일반적인 전원 켜짐 또는 리셋
        wake_count = 1
        print("전원 ON 또는 리셋 - 1번째 시작")

    print(f"총 경과 시간: 약 {(wake_count - 1) * 10}분")

    save_wake_count(wake_count)                          # wake count 저장

    indicate_wakeup_activity()                           # 작업 중 표시용 LED 점등

    print("10분 후 깨어남 예정")
    print("Deep Sleep 진입...")
    print("-" * 40)

    machine.deepsleep(600000)                            # 10분 동안 Deep Sleep 진입


#===========================================================================================
# 시작 지점                     
#===========================================================================================
if __name__ == "__main__":
    main()


# ==========================================================================================
#
#  (주)한국공학기술연구원 http://et.ketri.re.kr
#
# ==========================================================================================
